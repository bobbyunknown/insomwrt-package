#!/bin/bash

REPO_FILE="../config_passwall.txt"
TEMP_DIR="temp_packages"

CHECK_VERSION_DIR="package_version"

git clone --quiet --branch package --single-branch --depth 1 https://github.com/bobbyunknown/insomwrt-package.git "$CHECK_VERSION_DIR"

mkdir -p "$TEMP_DIR"
cd "$TEMP_DIR"

while IFS= read -r repo || [ -n "$repo" ]; do
    [[ $repo =~ ^#.*$ || -z $repo ]] && continue
    
    echo "Processing Passwall repository: $repo"
    
    LATEST_RELEASE=$(curl -s "https://api.github.com/repos/$repo/releases/latest")
    VERSION=$(echo $LATEST_RELEASE | jq -r '.tag_name')
    CURRENT_VERSION=""
    if [ -f "../$CHECK_VERSION_DIR/aarch64_generic/luci-app-passwall_version.txt" ]; then
        CURRENT_VERSION=$(cat "../$CHECK_VERSION_DIR/aarch64_generic/luci-app-passwall_version.txt")
    fi
    
    if [ "$VERSION" != "$CURRENT_VERSION" ]; then
        echo "Memperbarui PassWall ke versi $VERSION"
        
        MAIN_IPK=$(echo $LATEST_RELEASE | jq -r '.assets[] | select(.name | contains("luci-24.10_luci-app-passwall_")) | .browser_download_url')
        if [ ! -z "$MAIN_IPK" ]; then
            wget -q "$MAIN_IPK"
        fi
    
        ZIP_URL=$(echo $LATEST_RELEASE | jq -r '.assets[] | select(.name | endswith("aarch64_generic.zip")) | .browser_download_url')
        if [ ! -z "$ZIP_URL" ]; then
            wget -q "$ZIP_URL" -O temp.zip
            unzip -j temp.zip "*.ipk"
            rm temp.zip
        fi
        
        mkdir -p "../aarch64_generic"
        mv *.ipk "../aarch64_generic/"
        echo "$VERSION" > "../aarch64_generic/luci-app-passwall_version.txt"
    else
        echo "PassWall sudah versi terbaru ($VERSION)"
    fi
    
done < "$REPO_FILE"

cd ..
rm -rf "$TEMP_DIR"
rm -rf "$CHECK_VERSION_DIR"
